name: Algolia Search Scraper

on:
  schedule:
    - cron: "0 8 * * *"
  workflow_dispatch:

jobs:
  build:
    name: Trigger Algolia Scraper
    runs-on: ubuntu-latest
    environment: algolia
    strategy:
      matrix:
        version:
          [
            "teku",
            "goquorum",
            "zkevm",
            "tessera",
            "web3signer",
            "ethsigner",
            "qkm",
            "docs-template",
            "gnark",
          ]
    steps:
      - uses: actions/checkout@v3
      - id: config
        name: Read ${{ matrix.version }}.json
        shell: bash
        run: |
          content=$(cat ./.github/config/${{ matrix.version }}.json | jq -r tostring)
          echo "configJSON=$content" >> $GITHUB_OUTPUT
      - name: Checkout algolia/docsearch-scraper
        uses: actions/checkout@v3
        with:
          repository: algolia/docsearch-scraper
          path: "./algolia"
      - name: Set up Python
        uses: actions/setup-python@v4.5.0
        with:
          python-version: 3.6.15
      - name: Install pipenv
        shell: bash
        run: |
          cd ./algolia
          pip install pipenv
      - name: pipenv Pipfile
        shell: bash
        run: |
          pipenv install
      - name: pipenv
        shell: bash
        env:
          APPLICATION_ID: ${{ secrets.APPLICATION_ID }}
          API_KEY: ${{ secrets.API_KEY }}
          CONFIG: ${{ steps.config.outputs.configJSON }}
        run: |
          pipenv run python --version
          pipenv run pip freeze
          cd ./algolia/scraper
          pipenv run python -m src.index
